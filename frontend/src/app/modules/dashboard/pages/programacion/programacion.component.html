<div class="page-container">
  <!-- Title Section -->
  <div class="page-header-flex">
    <div class="header-text">
      <h1 class="page-title">Programación</h1>
      <p class="page-subtitle">Procesos automáticos por grupo.</p>
    </div>
    <button class="btn-new-programacion" (click)="openModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      Nueva Programación
    </button>
  </div>

  <!-- Filters Toolbar -->
  <div class="table-toolbar">
    <div class="search-input-wrapper">
      <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      <input type="text" placeholder="Buscar en toda la tabla ..." (input)="onSearch($event)">
    </div>
    
    <div class="filter-wrapper">
      <span class="filter-label">Estado</span>
      <select class="filter-select" (change)="onStatusChange($event)">
        <option value="TODOS">TODOS</option>
        <option value="ACTIVO">ACTIVO</option>
        <option value="INACTIVO">INACTIVO</option>
      </select>
    </div>
  </div>

  <!-- Table -->
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th style="width: 50px;">#</th>
          <th>Nombre de la programación</th>
          <th style="width: 150px;">Hora de ejecución</th>
          <th>Días</th>
          <th style="width: 180px;">Sociedades Incluidas</th>
          <th style="width: 120px; text-align: center;">Estado</th>
          <th style="width: 60px;"></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of filteredProgramaciones; let i = index">
          <td class="text-center">{{ item.id }}</td>
          <td>
            <div class="cell-primary-bold">{{ item.nombre }}</div>
          </td>
          <td class="cell-value">{{ item.hora }}</td>
          <td>
            <div class="days-container">
              <span class="day-badge" *ngFor="let dia of item.dias">{{ dia }}</span>
            </div>
          </td>
          <td>
            <div class="societies-cell">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7f8c8d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
              {{ item.sociedades }} sociedades
            </div>
          </td>
          <td class="text-center">
            <div class="toggle-switch" [class.active]="item.estado" (click)="toggleStatus(item)">
              <div class="toggle-knob"></div>
            </div>
          </td>
          <td class="text-center">
            <div class="action-buttons">
              <button class="btn-icon-eye" title="Ver/Editar">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#57606f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
              </button>
              <button class="btn-icon-delete" (click)="openDeleteModal(item)" title="Eliminar">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination-footer">
    <span class="pagination-info">Mostrando 1 – {{ filteredProgramaciones.length }} de {{ filteredProgramaciones.length }} resultados</span>
    <div class="pagination-controls">
      <button class="page-btn disabled">&lt;</button>
      <button class="page-btn active">1</button>
      <button class="page-btn disabled">&gt;</button>
    </div>
    <div class="rows-per-page">
      <span>Filas por página</span>
      <select>
        <option>10</option>
        <option>20</option>
        <option>50</option>
      </select>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div *ngIf="errorMessage || successMessage" class="toast-notification" [class.success]="successMessage && !errorMessage">
  <div class="toast-content">
    <div class="toast-icon">
      <svg *ngIf="errorMessage" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
      <svg *ngIf="successMessage && !errorMessage" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
    </div>
    <div class="toast-text">
      <h4 class="toast-title">{{ errorMessage ? 'Error' : 'Éxito' }}</h4>
      <p class="toast-message">{{ errorMessage || successMessage }}</p>
    </div>
    <button class="toast-close" (click)="errorMessage = ''; successMessage = ''">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
  </div>
</div>

<!-- Modal Confirmación Guardar -->
<div class="modal-overlay" *ngIf="isConfirmModalOpen" style="z-index: 3000;">
  <div class="modal-container confirm-modal" style="width: 500px;">
    <div class="modal-header">
      <div class="modal-title-wrapper">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3498db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
        <h2 style="color: #3498db;">Confirmar Programación</h2>
      </div>
      <button class="btn-close-modal" (click)="closeConfirmModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    <div class="modal-body" *ngIf="pendingPayload">
      <p style="margin-bottom: 15px;">Por favor verifica los datos antes de guardar:</p>
      
      <div class="confirm-details" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
        <div style="margin-bottom: 8px;"><strong>Nombre:</strong> {{ pendingPayload.tNombre }}</div>
        <div style="margin-bottom: 8px;"><strong>Hora:</strong> {{ pendingPayload.tHora }}</div>
        <div style="margin-bottom: 8px;">
          <strong>Días:</strong> 
          <span *ngFor="let dia of pendingPayload.tDias; let last = last">{{ dia }}<span *ngIf="!last">, </span></span>
        </div>
        <div><strong>Sociedades y Parámetros ({{ pendingPayload.sociedades.length }}):</strong></div>
        <div style="max-height: 250px; overflow-y: auto; margin-top: 5px; padding-right: 5px;">
          <div *ngFor="let soc of pendingSociedadesDisplay" style="margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #fff;">
            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 3px;">
              {{ soc.name }}
            </div>
            <div style="font-family: monospace; font-size: 0.85em; color: #333; line-height: 1.4;">
              <div>FOLDER="d:\\cosapi\\output" <span style="color: #95a5a6;">(Default)</span></div>
              <div>CODE_SOCIEDAD="{{ soc.codeSociedad }}"</div>
              <div>DATE="{{ pendingPayload.tDias.join(',') }}" <span style="color: #95a5a6;">(Configurado)</span></div>
              <div>RUC_SUNAT="{{ soc.ruc }}"</div>
              
              <div style="display: flex; align-items: center;">
                USER_SUNAT="{{ soc.sunatUser || 'MISSING' }}"
                <span *ngIf="soc.sunatUser" style="color: green; margin-left: 5px;">✔</span>
                <span *ngIf="!soc.sunatUser" style="color: red; margin-left: 5px;">✘</span>
              </div>
              
              <div style="display: flex; align-items: center;">
                PASSWORD_SUNAT="{{ soc.sunatPass ? '******' : 'MISSING' }}"
                <span *ngIf="soc.sunatPass" style="color: green; margin-left: 5px;">✔</span>
                <span *ngIf="!soc.sunatPass" style="color: red; margin-left: 5px;">✘</span>
              </div>
              
              <div style="display: flex; align-items: center;">
                CORREO_SAP="{{ soc.sapUser || 'MISSING' }}"
                <span *ngIf="soc.sapUser" style="color: green; margin-left: 5px;">✔</span>
                <span *ngIf="!soc.sapUser" style="color: red; margin-left: 5px;">✘</span>
              </div>
              
              <div style="display: flex; align-items: center;">
                PASSWORD_SAP="{{ soc.sapPass ? '******' : 'MISSING' }}"
                <span *ngIf="soc.sapPass" style="color: green; margin-left: 5px;">✔</span>
                <span *ngIf="!soc.sapPass" style="color: red; margin-left: 5px;">✘</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeConfirmModal()">Cancelar</button>
      <button class="btn-save" (click)="confirmSaveProgramacion()">Confirmar y Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Eliminar -->
<div class="modal-overlay" *ngIf="isDeleteModalOpen">
  <div class="modal-container delete-modal" style="width: 400px;">
    <div class="modal-header">
      <div class="modal-title-wrapper">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        <h2 style="color: #e74c3c;">Eliminar Programación</h2>
      </div>
      <button class="btn-close-modal" (click)="closeDeleteModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    <div class="modal-body">
      <p>¿Estás seguro que deseas eliminar la programación <strong>{{ itemToDelete?.nombre }}</strong>?</p>
      <p class="text-muted" style="color: #7f8c8d; font-size: 0.9rem;">Esta acción no se puede deshacer.</p>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeDeleteModal()">Cancelar</button>
      <button class="btn-delete-confirm" style="background-color: #e74c3c; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; cursor: pointer;" (click)="confirmDelete()">Eliminar</button>
    </div>
  </div>
</div>

<!-- Modal Nueva Programación -->
<div class="modal-overlay" *ngIf="isModalOpen">
  <div class="modal-container">
    <div class="modal-header">
      <div class="modal-title-wrapper">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
        <h2>Nueva Programación</h2>
      </div>
      <button class="btn-close-modal" (click)="closeModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    
    <div class="modal-body">
      <!-- Nombre y Hora -->
      <div class="form-row">
        <div class="form-group col-name">
          <label>Nombre de la programación</label>
          <input type="text" [(ngModel)]="newProgramacion.nombre" class="form-control">
        </div>
        <div class="form-group col-time">
          <label>Hora de ejecución</label>
          <div class="custom-select-wrapper">
            <div *ngIf="isTimePickerOpen" class="dropdown-backdrop" (click)="toggleTimePicker()"></div>
            <div class="custom-select-container" [class.open]="isTimePickerOpen">
              <div class="custom-select-header" (click)="toggleTimePicker()">
                <span>{{ selectedHour }}:{{ selectedMinute }}</span>
                <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
              </div>
              <div class="custom-select-body" [class.visible]="isTimePickerOpen" (click)="$event.stopPropagation()">
                <div class="time-selector">
                  <div class="time-column">
                    <div *ngFor="let h of hours" 
                         class="time-item" 
                         [class.selected]="h === selectedHour"
                         (click)="selectHour(h)">
                      {{ h }}
                    </div>
                  </div>
                  <div class="time-separator">:</div>
                  <div class="time-column">
                    <div *ngFor="let m of minutes" 
                         class="time-item" 
                         [class.selected]="m === selectedMinute"
                         (click)="selectMinute(m)">
                      {{ m }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Días de Repetición -->
      <div class="form-group">
        <label>Días de Repetición</label>
        <div class="days-selector">
          <button *ngFor="let dia of newProgramacion.dias; let i = index" 
                  class="day-btn" 
                  [class.selected]="dia.selected"
                  (click)="toggleDay(i)">
            {{ dia.label }}
          </button>
        </div>
      </div>

      <!-- Sociedades a incluir -->
      <div class="form-group societies-section">
        <div class="societies-header">
          <ng-container *ngIf="!showSocietySearch">
            <label>Sociedades a incluir <span class="count">({{ selectedSocietiesCount }})</span></label>
            <button class="btn-search-societies" (click)="toggleSocietySearch()">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </button>
          </ng-container>
          <div *ngIf="showSocietySearch" class="society-search-wrapper">
            <input type="text" [(ngModel)]="societySearchTerm" placeholder="Buscar..." class="society-search-input">
            <button class="btn-close-search" (click)="toggleSocietySearch()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
          </div>
        </div>
        
        <div class="societies-list">
          <div class="society-item-wrapper" *ngFor="let soc of filteredSocieties" [class.selected]="soc.selected" [class.disabled]="!soc.estado" [title]="!soc.estado ? 'Desactivado' : ''">
            <div class="society-item">
              <div class="checkbox-wrapper" (click)="toggleSociety(soc)">
                <div class="custom-checkbox" [class.checked]="soc.selected">
                  <svg *ngIf="soc.selected" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </div>
              </div>
              <div class="society-info">
                <div class="society-name">{{ soc.name }}</div>
                <div class="society-id">{{ soc.id }}</div>
              </div>
              <!-- SUNAT Status Check -->
              <div class="sunat-status" *ngIf="soc.hasSunatCredentials">
                  <span class="badge-sunat">
                    SUNAT 
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                      <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                  </span>
              </div>
            </div>
            
            <!-- SAP Account Dropdown (Only visible if selected) -->
            <div class="sap-account-selector" *ngIf="soc.selected">
                <div class="sap-selector-label">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    Cuenta SAP:
                </div>
                
                <div *ngIf="soc.loadingSap" class="sap-loading">Cargando...</div>
                
                <select *ngIf="!soc.loadingSap && soc.sapAccounts.length > 0" 
                        class="sap-select" 
                        [(ngModel)]="soc.selectedSapAccount">
                    <option *ngFor="let account of soc.sapAccounts" [ngValue]="account">
                        {{ account.tUsuario }}
                    </option>
                </select>
                
                <div *ngIf="!soc.loadingSap && soc.sapAccounts.length === 0" class="sap-warning">
                    ⚠️ Sin cuentas SAP
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        Cancelar
      </button>
      <button class="btn-save" (click)="preSaveProgramacion()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
        Guardar Programación
      </button>
    </div>
  </div>
</div>
