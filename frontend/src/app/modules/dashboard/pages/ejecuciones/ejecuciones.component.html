<div class="page-container">
  <!-- Title Section -->
  <div class="page-header">
    <h1 class="page-title">Ejecuciones a demanda</h1>
    <p class="page-subtitle">Visualice y administre el historial de ejecuciones de procesos en tiempo real.</p>
  </div>

  <!-- Filters Toolbar -->
  <div class="table-toolbar">
    <div class="search-input-wrapper">
      <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      <input type="text" placeholder="Buscar en toda la tabla ..." (input)="onSearch($event)">
    </div>
    
    <div class="filter-wrapper">
      <span class="filter-label">Estado</span>
      <select class="filter-select" (change)="onStatusChange($event)">
        <option value="TODOS">TODOS</option>
        <option value="Ejecutar">Ejecutar</option>
        <option value="Procesando">Procesando</option>
      </select>

      <button class="btn-whitelist" (click)="openWhitelistModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        Lista Blanca
      </button>
    </div>
  </div>

  <!-- Table -->
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th style="width: 50px;">#</th>
          <th style="width: 320px;">Nombre Completo</th>
          <th style="width: 170px;">Última Ejecución</th>
          <th style="width: 180px; text-align: center;">Total Ejecuciones</th>
          <th style="width: 160px;">Seleccionar Fecha</th>
          <th style="width: 250px;"></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of filteredEjecuciones">
          <td class="text-center">{{ item.id }}</td>
          <td>
            <div class="cell-primary">{{ item.nombre }}</div>
            <div class="cell-secondary">{{ item.ruc }}</div>
          </td>
          <td class="cell-value">{{ item.ultimaEjecucion }}</td>
          <td class="text-center cell-value">{{ item.totalEjecuciones }}</td>
          <td>
            <div class="date-picker-placeholder">
              <span>Seleccionar</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            </div>
          </td>
          <td class="actions-cell-wrapper">
            <div class="actions-cell-content">
              <button class="btn-status" [ngClass]="getStatusClass(item.estado)">
                {{ item.estado }}
                <span *ngIf="item.estado === 'Ejecutar'" class="status-icon">▶</span>
                <span *ngIf="item.estado === 'Procesando'" class="status-icon spinner"></span>
              </button>
              
              <button class="btn-icon-sm" (click)="openDrawer(item)">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination-footer">
    <span class="pagination-info">Mostrando 1 – 15 de 248 resultados</span>
    <div class="pagination-controls">
      <button class="page-btn disabled">&lt;</button>
      <button class="page-btn active">1</button>
      <button class="page-btn">2</button>
      <button class="page-btn">3</button>
      <button class="page-btn">4</button>
      <button class="page-btn">&gt;</button>
    </div>
    <div class="rows-per-page">
      <span>Filas por página</span>
      <select>
        <option>10</option>
        <option>20</option>
        <option>50</option>
      </select>
    </div>
  </div>
</div>

<!-- Logs Modal & Backdrop -->
<div class="log-modal-backdrop" *ngIf="isLogModalOpen" (click)="closeLogModal()"></div>
<div class="log-modal" *ngIf="isLogModalOpen">
  
  <div class="log-modal-header">
    <div class="log-modal-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
      Logs
    </div>
    <button class="btn-close-circle" (click)="closeLogModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
  </div>

  <div class="log-task-info" *ngIf="selectedLogTask">
    <div class="task-info-left">
      <span class="task-name">{{ selectedLogTask.nombre }}</span>
      <span class="badge" [ngClass]="selectedLogTask.tipo === 'Programación' ? 'badge-blue' : 'badge-yellow'">
        {{ selectedLogTask.tipo }}
      </span>
    </div>
    <span class="task-time" *ngIf="selectedLogTask.detalle.includes('Prog.:')">Hora: {{ selectedLogTask.detalle.split('Prog.: ')[1] }}</span>
  </div>

  <div class="log-table-container">
    <table class="log-table">
      <thead>
        <tr>
          <th>Fecha/hora</th>
          <th>Configuración</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let log of selectedLogTask?.logs">
          <td>{{ log.fecha }}</td>
          <td>{{ log.configuracion }}</td>
          <td>
            <span class="log-status-badge" 
                  [ngClass]="{'status-completed': log.estado === 'Completado', 'status-process': log.estado.includes('Proceso'), 'status-failed': log.estado === 'Fallido'}">
              <span *ngIf="log.estado === 'Completado'" class="icon-check">✔</span>
              <span *ngIf="log.estado.includes('Proceso')" class="icon-spinner"></span>
              {{ log.estado }}
            </span>
          </td>
        </tr>
        <tr *ngIf="!selectedLogTask?.logs || selectedLogTask?.logs.length === 0">
          <td colspan="3" class="text-center">No hay logs disponibles para esta tarea.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Whitelist Modal & Backdrop -->
<div class="log-modal-backdrop" *ngIf="isWhitelistModalOpen" (click)="closeWhitelistModal()"></div>
<div class="log-modal" *ngIf="isWhitelistModalOpen">
  
  <div class="log-modal-header">
    <div class="log-modal-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
      Lista Blanca
    </div>
    <button class="btn-close-circle" (click)="closeWhitelistModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
  </div>

  <div class="log-task-info" *ngIf="globalWhitelist">
    <div class="task-info-left" style="flex-direction: column; align-items: flex-start; gap: 0.2rem;">
      <span class="task-name" style="font-size: 1rem; line-height: 1.2;">Detalle de Proveedores</span>
      <span style="font-size: 0.8rem; color: #95a5a6; line-height: 1.2;">Configuración global de la plataforma</span>
    </div>
    <div class="whitelist-summary" style="text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 0;">
        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50; line-height: 1.1;">{{ globalWhitelist ? globalWhitelist.length : 0 }}</div>
        <div style="font-size: 0.8rem; color: #95a5a6; line-height: 1.2;">Proveedores habilitados</div>
    </div>
  </div>

  <div class="log-table-container">
    <table class="log-table">
      <thead>
        <tr>
          <th>RUC</th>
          <th>Razón Social</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let prov of globalWhitelist">
          <td style="font-family: monospace; font-weight: 600;">{{ prov.ruc }}</td>
          <td>{{ prov.razonSocial }}</td>
        </tr>
        <tr *ngIf="!globalWhitelist || globalWhitelist.length === 0">
          <td colspan="2" class="text-center">No hay proveedores en lista blanca.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Drawer & Backdrop -->
<div class="drawer-backdrop" *ngIf="isDrawerOpen" (click)="closeDrawer()"></div>
<div class="drawer-panel" [class.open]="isDrawerOpen">
  
  <!-- Header Custom -->
  <div class="drawer-header-custom" *ngIf="selectedExecution">
    <div class="company-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18"/><path d="M5 21V7l8-4 8 4v14"/><path d="M17 21v-8.5a1.5 1.5 0 0 0-1.5-1.5h-5a1.5 1.5 0 0 0-1.5 1.5V21"/><path d="M9 10a1 1 0 0 1 1-1"/><path d="M14 10a1 1 0 0 1 1-1"/><path d="M9 14a1 1 0 0 1 1-1"/><path d="M14 14a1 1 0 0 1 1-1"/></svg>
    </div>
    <div class="company-info">
      <h2>{{ selectedExecution.nombre }}</h2>
      <span class="company-ruc">RUC: {{ selectedExecution.ruc }}</span>
    </div>
    <button class="btn-close-circle" (click)="closeDrawer()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
  </div>

  <div class="drawer-content-custom" *ngIf="selectedExecution">
    
    <!-- Ejecuciones Activas -->
    <div class="section-title">Ejecuciones Activas</div>
    
    <div class="execution-card" *ngFor="let act of selectedExecution.activas">
      <div class="card-header-row">
        <span class="card-title">{{ act.nombre }}</span>
        <span class="badge" [ngClass]="act.tipo === 'Programación' ? 'badge-blue' : 'badge-yellow'">
          {{ act.tipo }}
        </span>
        <div class="card-icon-right" (click)="openLogModal(act, $event)">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#95a5a6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        </div>
      </div>
      <div class="card-detail">{{ act.detalle }}</div>
      <div class="progress-container">
        <div class="progress-track">
          <div class="progress-fill" [style.width.%]="act.progreso"></div>
        </div>
        <span class="progress-text">{{ act.progreso }}%</span>
      </div>
    </div>

    <!-- Historial -->
    <div class="section-title mt-4" *ngIf="selectedExecution.historial && selectedExecution.historial.length > 0">Historial de ejecuciones</div>

    <div class="execution-card" *ngFor="let hist of selectedExecution.historial">
      <div class="card-date">{{ hist.fecha }}</div>
      <div class="card-header-row">
        <span class="card-title">{{ hist.nombre }}</span>
        <span class="badge" [ngClass]="hist.tipo === 'Programación' ? 'badge-blue' : 'badge-yellow'">
          {{ hist.tipo }}
        </span>
        <div class="card-icon-right" (click)="openLogModal(hist, $event)">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#95a5a6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        </div>
      </div>
      <div class="card-detail">{{ hist.detalle }}</div>
    </div>

  </div>
</div>
