<div class="page-container">
  <!-- Title Section -->
  <div class="page-header">
    <h1 class="page-title">Ejecuciones a demanda</h1>
    <p class="page-subtitle">Visualice y administre el historial de ejecuciones de procesos en tiempo real.</p>
  </div>

<!-- Parameters Modal -->
<div *ngIf="isParamsModalOpen" class="modal-backdrop">
  <div class="modal-card">
    <div class="modal-header">
      <h3>Confirmar Ejecución Manual</h3>
      <button class="modal-close-btn" (click)="closeParamsModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    <div class="modal-body">
      <p class="modal-intro">Verifique los parámetros que serán enviados al servicio.</p>
      
      <!-- SUNAT Section -->
      <div class="summary-group">
        <div class="group-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
             <h4 style="margin: 0;">Configuración SUNAT</h4>
        </div>
        <div class="summary-item">
          <span class="label">RUC:</span>
          <span class="value">{{ selectedParamsTask?.ruc }}</span>
        </div>
        <div class="summary-item">
            <span class="label">Usuario SOL:</span>
            <span class="value">{{ selectedParamsTask?.sunatUsuario || 'No definido' }}</span>
        </div>
        <div class="summary-item">
            <span class="label">Clave SOL:</span>
            <div class="value-wrapper" style="display: flex; align-items: center; gap: 8px;">
                <span class="value">{{ showSunatPassword ? selectedParamsTask?.sunatClave : '******' }}</span>
                <button class="btn-icon-sm" (click)="showSunatPassword = !showSunatPassword" title="Mostrar/Ocultar">
                    <svg *ngIf="!showSunatPassword" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    <svg *ngIf="showSunatPassword" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                </button>
            </div>
        </div>
      </div>

      <!-- SAP Section -->
      <div class="summary-group">
        <div class="group-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
             <h4 style="margin: 0;">Configuración SAP</h4>
        </div>
        
        <div *ngIf="isLoadingSap" style="padding: 10px; color: #666; font-style: italic;">Cargando credenciales SAP...</div>

        <ng-container *ngIf="!isLoadingSap">
            <div class="summary-item">
                <span class="label">Usuario SAP:</span>
                <span class="value">{{ selectedParamsTask?.sapUsuario }}</span>
            </div>
            <div class="summary-item">
                <span class="label">Contraseña:</span>
                <div class="value-wrapper" style="display: flex; align-items: center; gap: 8px;">
                    <span class="value">{{ showSapPassword ? selectedParamsTask?.sapClave : '******' }}</span>
                    <button class="btn-icon-sm" (click)="showSapPassword = !showSapPassword" title="Mostrar/Ocultar">
                        <svg *ngIf="!showSapPassword" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        <svg *ngIf="showSapPassword" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                    </button>
                </div>
            </div>
        </ng-container>
      </div>

      <!-- General Section -->
      <div class="summary-group">
        <h4>Parámetros de Ejecución</h4>
        <div class="summary-item">
            <span class="label">Sociedad:</span>
            <span class="value">{{ selectedParamsTask?.codigoSap || 'CODIGO_NO_ENCONTRADO' }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Fecha Seleccionada:</span>
          <span class="value" style="font-weight: bold; color: #3498db;">{{ selectedParamsTask?.selectedDateFormatted }}</span>
        </div>
        <div class="summary-item">
            <span class="label">Carpeta de Salida:</span>
            <div style="display: flex; flex-direction: column;">
                <span class="value" style="font-family: monospace; font-size: 0.8rem; background: #f8f9fa; padding: 4px; border-radius: 4px;">/home/sertech/sunat-sap/{{ selectedParamsTask?.codigoSap || 'CODIGO_NO_ENCONTRADO' }}_{{ selectedParamsTask?.selectedDate | date:'ddMMyy' }}</span>
                <span style="font-size: 0.75rem; color: #95a5a6; margin-top: 2px;">(Ruta en servidor Linux - Archivos Excel)</span>
            </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeParamsModal()">Cancelar</button>
      <button class="btn-confirm" (click)="executeFromModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
        Confirmar y Ejecutar
      </button>
    </div>
  </div>
</div>



  <!-- Filters Toolbar -->
  <div class="table-toolbar">
    <div class="search-input-wrapper">
      <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      <input type="text" placeholder="Buscar en toda la tabla ..." (input)="onSearch($event)">
    </div>
    
    <div class="filter-wrapper">
      <span class="filter-label">Estado</span>
      <select class="filter-select" (change)="onStatusChange($event)">
        <option value="TODOS">TODOS</option>
        <option value="Ejecutar">Ejecutar</option>
        <option value="Procesando">Procesando</option>
      </select>

      <button class="btn-whitelist" (click)="openWhitelistModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        Lista Blanca ({{ globalWhitelist ? globalWhitelist.length : 0 }})
      </button>
    </div>
  </div>

  <!-- Table -->
  <div class="table-container">
    <table class="main-table">
      <thead>
        <tr>
          <th style="width: 50px;">#</th>
          <th style="width: 320px;">Nombre Completo</th>
          <th style="width: 170px;">Última Ejecución</th>
          <th style="width: 180px; text-align: center;">Total Ejecuciones</th>
          <th style="width: 210px;">Seleccionar Fecha</th>
          <th style="width: 250px;"></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of filteredEjecuciones">
          <td class="text-center">{{ item.id }}</td>
          <td>
            <div class="cell-primary">{{ item.nombre }}</div>
            <div class="cell-secondary">{{ item.ruc }}</div>
          </td>
          <td class="cell-value">{{ item.ultimaEjecucion }}</td>
          <td class="text-center cell-value">{{ item.totalEjecuciones }}</td>
          <td>
            <div class="custom-select-wrapper custom-date-wrapper">
                <div *ngIf="activeCalendarRowId === item.id" class="dropdown-backdrop" (click)="activeCalendarRowId = null"></div>
                
                <div class="custom-select-container" [class.open]="activeCalendarRowId === item.id">
                    <div class="custom-select-header" (click)="toggleCalendar(item, $event)" [class.placeholder]="!item.selectedDate">
                      <span>{{ item.selectedDateFormatted || 'Seleccionar' }}</span>
                      <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    </div>
                    
                    <div class="custom-select-body calendar-popup" [class.visible]="activeCalendarRowId === item.id" (click)="$event.stopPropagation()">
                      <div class="calendar-header">
                        <button type="button" (click)="changeMonth(-1, $event)">
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        </button>
                        <span>{{ months[currentCalendarDate.getMonth()] }} {{ currentCalendarDate.getFullYear() }}</span>
                        <button type="button" (click)="changeMonth(1, $event)">
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </button>
                      </div>
                      
                      <div class="calendar-weekdays">
                        <div *ngFor="let day of weekDays">{{ day }}</div>
                      </div>
                      
                      <div class="calendar-grid">
                        <div *ngFor="let dayObj of daysInMonth" 
                             class="calendar-day" 
                             [class.other-month]="!dayObj.currentMonth"
                             [class.selected]="item.selectedDate && dayObj.date.getTime() === item.selectedDate.getTime()"
                             (click)="selectDate(dayObj, item)">
                          {{ dayObj.day }}
                        </div>
                      </div>
                    </div>
                </div>
            </div>
          </td>
          <td class="actions-cell-wrapper">
            <div class="actions-cell-content">
              <button class="btn-status" [ngClass]="getStatusClass(item.estado)" (click)="openParamsModal(item)">
                {{ item.estado }}
                <span *ngIf="item.estado === 'Ejecutar'" class="status-icon">▶</span>
                <span *ngIf="item.estado === 'Procesando'" class="status-icon spinner"></span>
              </button>
              
              <button class="btn-icon-sm" (click)="openExecutionModal(item)" title="Ver Historial">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination-footer">
    <span class="pagination-info">Mostrando 1 – 15 de 248 resultados</span>
    <div class="pagination-controls">
      <button class="page-btn disabled">&lt;</button>
      <button class="page-btn active">1</button>
      <button class="page-btn">2</button>
      <button class="page-btn">3</button>
      <button class="page-btn">4</button>
      <button class="page-btn">&gt;</button>
    </div>
    <div class="rows-per-page">
      <span>Filas por página</span>
      <select>
        <option>10</option>
        <option>20</option>
        <option>50</option>
      </select>
    </div>
  </div>
</div>



<!-- Whitelist Modal & Backdrop -->
<div class="log-modal-backdrop" *ngIf="isWhitelistModalOpen" (click)="closeWhitelistModal()"></div>
<div class="log-modal" *ngIf="isWhitelistModalOpen">
  
  <div class="log-modal-header">
    <div class="log-modal-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
      Lista Blanca
    </div>
    <button class="btn-close-circle" (click)="closeWhitelistModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
  </div>

  <div class="log-task-info" *ngIf="globalWhitelist">
    <div class="task-info-left" style="flex-direction: column; align-items: flex-start; gap: 0.2rem;">
      <span class="task-name" style="font-size: 1rem; line-height: 1.2;">Detalle de Proveedores</span>
      <span style="font-size: 0.8rem; color: #95a5a6; line-height: 1.2;">Configuración global de la plataforma</span>
    </div>
    <div class="whitelist-summary" style="text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 0;">
        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50; line-height: 1.1;">{{ globalWhitelist ? globalWhitelist.length : 0 }}</div>
        <div style="font-size: 0.8rem; color: #95a5a6; line-height: 1.2;">Proveedores habilitados</div>
    </div>
  </div>

  <div class="search-input-wrapper" style="margin-bottom: 1rem;">
      <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      <input type="text" placeholder="Buscar por RUC o Sociedad Vinculada: " (input)="onWhitelistSearch($event)" style="width: 100%;">
  </div>

  <div class="log-table-container">
    <table class="log-table">
      <thead>
        <tr>
          <th>RUC</th>
          <th>Razón Social</th>
          <th>Sociedad Vinculada</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let prov of paginatedWhitelist">
          <td style="font-family: monospace; font-weight: 600;">{{ prov.ruc }}</td>
          <td>{{ prov.razonSocial }}</td>
          <td>{{ prov.sociedadesNombres }}</td>
        </tr>
        <tr *ngIf="!filteredWhitelist || filteredWhitelist.length === 0">
          <td colspan="3" class="text-center">No se encontraron proveedores.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="pagination-simple" *ngIf="filteredWhitelist.length > whitelistItemsPerPage">
      <span style="margin-right: 1rem;">Página {{ whitelistCurrentPage }} de {{ totalWhitelistPages }}</span>
      <div class="pagination-controls-simple">
          <button class="page-btn-simple" [disabled]="whitelistCurrentPage === 1" (click)="changeWhitelistPage(-1)">&lt;</button>
          <button class="page-btn-simple" [disabled]="whitelistCurrentPage === totalWhitelistPages" (click)="changeWhitelistPage(1)">&gt;</button>
      </div>
  </div>
</div>

<!-- Execution Modal & Backdrop -->
<div class="log-modal-backdrop" *ngIf="isExecutionModalOpen || isExecutionModalClosing" [class.closing]="isExecutionModalClosing" (click)="closeExecutionModal()"></div>
<div class="log-modal execution-modal" *ngIf="isExecutionModalOpen || isExecutionModalClosing" [class.closing]="isExecutionModalClosing" [class.shifted-left]="isLogModalOpen && !isLogModalClosing">
  
  <!-- Header Custom -->
  <div class="drawer-header-custom" *ngIf="selectedExecution">
    <div class="company-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18"/><path d="M5 21V7l8-4 8 4v14"/><path d="M17 21v-8.5a1.5 1.5 0 0 0-1.5-1.5h-5a1.5 1.5 0 0 0-1.5 1.5V21"/><path d="M9 10a1 1 0 0 1 1-1"/><path d="M14 10a1 1 0 0 1 1-1"/><path d="M9 14a1 1 0 0 1 1-1"/><path d="M14 14a1 1 0 0 1 1-1"/></svg>
    </div>
    <div class="company-info">
      <h2>{{ selectedExecution.nombre }}</h2>
      <span class="company-ruc">RUC: {{ selectedExecution.ruc }}</span>
    </div>
    <button class="btn-close-circle" (click)="closeExecutionModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
  </div>

  <div class="drawer-content-custom" *ngIf="selectedExecution">
    
    <!-- Ejecuciones Activas -->
    <div class="section-title">Ejecuciones Activas</div>
    
    <div class="log-table-container">
      <table class="log-table">
        <thead>
          <tr>
            <th style="width: 35%;">Configuración</th>
            <th style="width: 20%; text-align: center;">T. Ejecución</th>
            <th style="width: 45%; text-align: center;">Estado</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let act of selectedExecution.activas" style="background-color: #FAFAFA;">
            <!-- Configuración -->
            <td>
              <div style="font-weight: 600; color: #2c3e50; font-size: 0.95rem;">{{ act.nombre }}</div>
              <div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 2px;">{{ act.detalle }}</div>
            </td>
            
            <!-- T. Ejecución -->
            <td style="text-align: center;">
              <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                  <span class="badge" [ngClass]="act.tipo === 'Programación' ? 'badge-blue' : 'badge-yellow'" style="font-size: 0.85rem;">
                    {{ act.tipo }}
                  </span>
                  <!-- Play Button for 'Programación' -->
                  <button *ngIf="act.tipo === 'Programación'" class="btn-icon-sm" (click)="runProgramacion(act.id, selectedExecution.ruc)" title="Ejecutar Ahora" style="color: #2ecc71; padding: 2px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                  </button>
              </div>
            </td>

            <!-- Estado -->
            <td>
              <div style="display: flex; align-items: center; justify-content: flex-end; gap: 10px;">
                  <!-- Status Pill -->
                  <div class="log-status-badge status-process" style="padding: 0.25rem 0.75rem; font-size: 0.8rem; background-color: #F1F5F9; border: 1px solid #CBD5E1; color: #475569; border-radius: 20px;">
                    <div class="icon-spinner" style="width: 10px; height: 10px; border-width: 2px; margin-right: 6px;"></div>
                    <span>Proceso ({{ act.progreso }}%)...</span>
                  </div>
                  
                  <!-- Eye Icon (Log Modal) -->
                  <button class="btn-icon-sm" (click)="openLogModal(act, $event)" title="Ver Detalle" style="color: #95a5a6;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#95a5a6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                  </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Historial -->
    <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 1.5rem; margin-bottom: 0.75rem;">
      <div class="section-title" style="margin-bottom: 0; margin-left: 0;">Historial de ejecuciones</div>
      
      <div style="display: flex; gap: 10px;">
          <!-- Date Range Picker (Mock) -->
          <div style="position: relative; display: flex; align-items: center;">
              <input type="text" [value]="historyDateRange" readonly style="padding: 0.4rem 2rem 0.4rem 0.8rem; border: 1px solid #C9CDCF; border-radius: 6px; font-size: 0.85rem; color: #2c3e50; outline: none; width: 200px; cursor: pointer;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#57606f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="position: absolute; right: 10px; pointer-events: none;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          </div>
          
          <!-- Excel Button -->
          <button (click)="exportHistoryExcel()" style="display: flex; align-items: center; gap: 6px; background-color: #107c41; color: white; border: none; padding: 0.4rem 1rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
              Excel
          </button>
      </div>
    </div>

    <div class="log-table-container">
      <table class="log-table">
        <thead>
          <tr>
            <th style="width: 35%;">Configuración</th>
            <th style="width: 20%; text-align: center;">T. Ejecución</th>
            <th style="width: 25%;">Fecha Ejecución</th>
            <th style="width: 20%;"></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let hist of paginatedHistory" style="background-color: #FAFAFA;">
            <!-- Configuración -->
            <td>
              <div style="font-weight: 600; color: #2c3e50; font-size: 0.95rem;">{{ hist.nombre }}</div>
              <div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 2px;">{{ hist.detalle }}</div>
            </td>
            
            <!-- T. Ejecución -->
            <td style="text-align: center;">
                <span class="badge" [ngClass]="hist.tipo === 'Programación' ? 'badge-blue' : 'badge-yellow'" style="font-size: 0.85rem;">
                  {{ hist.tipo }}
                </span>
            </td>

            <!-- Fecha Ejecución -->
            <td>
                <div style="font-size: 0.85rem; color: #2c3e50;">{{ hist.fecha }}</div>
            </td>

            <!-- Icon -->
            <td style="text-align: right;">
                <button class="btn-icon-sm" (click)="openLogModal(hist, $event)" title="Ver Logs" style="color: #95a5a6; margin-right: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                </button>
                <button class="btn-icon-sm" (click)="downloadFiles(hist)" title="Descargar Archivos" style="color: #3498db;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                </button>
            </td>
          </tr>
          <tr *ngIf="paginatedHistory.length === 0">
              <td colspan="4" style="text-align: center; padding: 2rem; color: #95a5a6;">No hay historial disponible</td>
          </tr>
        </tbody>
      </table>
      
      <!-- Pagination Footer -->
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; border-top: 1px solid #C9CDCF; background-color: #F4F5F6;">
          <!-- Controls -->
          <div style="display: flex; align-items: center; gap: 5px;">
              <button class="page-btn" [disabled]="historyCurrentPage === 1" (click)="changeHistoryPage(-1)">&lt;</button>
              
              <button class="page-btn" 
                      [class.active]="historyCurrentPage === 1" 
                      (click)="setHistoryPage(1)">1</button>
              
              <span *ngIf="historyCurrentPage > 3">...</span>
              
              <ng-container *ngFor="let p of [historyCurrentPage-1, historyCurrentPage, historyCurrentPage+1]">
                  <button *ngIf="p > 1 && p < historyTotalPages" 
                          class="page-btn" 
                          [class.active]="historyCurrentPage === p" 
                          (click)="setHistoryPage(p)">{{ p }}</button>
              </ng-container>

              <span *ngIf="historyCurrentPage < historyTotalPages - 2">...</span>

              <button *ngIf="historyTotalPages > 1" 
                      class="page-btn" 
                      [class.active]="historyCurrentPage === historyTotalPages" 
                      (click)="setHistoryPage(historyTotalPages)">{{ historyTotalPages }}</button>
              
              <button class="page-btn" [disabled]="historyCurrentPage === historyTotalPages" (click)="changeHistoryPage(1)">&gt;</button>
          </div>

          <!-- Items per page -->
          <div class="rows-per-page">
              <span>Filas por página</span>
              <select (change)="onHistoryItemsPerPageChange($event)" [value]="historyItemsPerPage" style="border: 1px solid #C9CDCF; border-radius: 4px; padding: 0.2rem 0.5rem; outline: none; background: white;">
                  <option [value]="5">5</option>
                  <option [value]="10">10</option>
                  <option [value]="20">20</option>
              </select>
          </div>
      </div>
    </div>

  </div>
</div>

<!-- Logs Modal & Backdrop -->
<div class="log-modal-backdrop transparent-backdrop" *ngIf="isLogModalOpen" (click)="closeLogModal()"></div>
<div class="log-modal log-details-modal shifted-right" *ngIf="isLogModalOpen" [class.closing]="isLogModalClosing">
  
  <div class="log-modal-header">
    <div class="log-modal-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
      Logs
    </div>
    <button class="btn-close-circle" (click)="closeLogModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
  </div>

  <div class="log-task-info" *ngIf="selectedLogTask">
    <div class="task-info-left">
      <span class="task-name">{{ selectedLogTask.nombre }}</span>
      <span class="badge" [ngClass]="selectedLogTask.tipo === 'Programación' ? 'badge-blue' : 'badge-yellow'">
        {{ selectedLogTask.tipo }}
      </span>
    </div>
    <span class="task-time" *ngIf="selectedLogTask.detalle.includes('Prog.:')">Hora: {{ selectedLogTask.detalle.split('Prog.: ')[1] }}</span>
  </div>

  <div class="log-table-container">
    <table class="log-table">
      <thead>
        <tr>
          <th>Fecha/hora</th>
          <th>Configuración</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let log of selectedLogTask?.logs">
          <td style="white-space: nowrap; font-size: 0.8rem;">{{ log.fecha }}</td>
          <td>{{ log.configuracion }}</td>
          <td>
            <!-- Check if status matches standard short statuses -->
            <span *ngIf="['Completado', 'Fallido'].includes(log.estado) || log.estado.includes('Proceso')" 
                  class="log-status-badge" 
                  [ngClass]="{'status-completed': log.estado === 'Completado', 'status-process': log.estado.includes('Proceso'), 'status-failed': log.estado === 'Fallido'}">
              <span *ngIf="log.estado === 'Completado'" class="icon-check">✔</span>
              <span *ngIf="log.estado.includes('Proceso')" class="icon-spinner"></span>
              {{ log.estado }}
            </span>
            
            <!-- For detailed logs (green text) -->
            <span *ngIf="!(['Completado', 'Fallido'].includes(log.estado) || log.estado.includes('Proceso'))"
                  [style.color]="log.estado.includes('✅') ? '#27ae60' : 'inherit'"
                  [style.fontWeight]="log.estado.includes('✅') ? '600' : 'normal'">
                  {{ log.estado }}
            </span>
          </td>
        </tr>
        <tr *ngIf="!selectedLogTask?.logs || selectedLogTask?.logs.length === 0">
          <td colspan="3" class="text-center">No hay logs disponibles para esta tarea.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
